#!/bin/bash
set -euo pipefail
: "${username:=alan}"
: "${password:=demo}"
: "${baseurl:=https://cloud.opencloud.test}"
: "${prefix:=/groupware}"
: "${keycloak:=https://keycloak.opencloud.test}"
: "${realm:=openCloud}"
: "${client_id:=groupware}"

declare -a args
url=''
for a in "$@"; do
  case "$a" in
    //*) args+=("${baseurl}${prefix}${a#/}");;
    /*) args+=("${baseurl}$a");;
    *) args+=("$a");;
  esac
done

token=$(curl -ks -X POST "${keycloak}/realms/${realm}/protocol/openid-connect/token" -d username="${username}" -d password="${password}" -d grant_type=password -d client_id="${client_id}" -d scope=openid | jq -r '.access_token')

[[ -n "${HTTP-}" ]] && exec $HTTP -A bearer -a "${token}" "${args[@]}"
type -p https &>/dev/null && exec https --verify=no -A bearer -a "${token}" "${args[@]}"
type -p xh &>/dev/null && exec xh --verify=no -A bearer -a "${token}" "${args[@]}"
